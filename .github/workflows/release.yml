name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version name for artifacts'
        default: 'test'

env:
  VERSION: ${{ inputs.version || github.ref_name }}

jobs:
  linux:
    runs-on: ubuntu-latest
    container: alpine:latest
    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache git build-base cmake linux-headers wget \
                             libuv-dev libuv-static openssl-dev openssl-libs-static \
                             nghttp2-dev nghttp2-static

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build hwloc static
        run: |
          cd scripts
          sh build.hwloc.sh

      - name: Build
        run: |
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_STATIC=ON -DWITH_OPENCL=OFF -DWITH_CUDA=OFF -DXMRIG_DEPS=scripts/deps
          make -j$(nproc)
          strip vltrig

      - name: Stage artifact
        run: |
          mkdir -p staging
          cp build/vltrig scripts/vltrig/run.sh src/config.json staging/
          cd staging && sha256sum * > SHA256SUMS

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: vltrig-${{ env.VERSION }}-linux-x64
          path: staging/*

      - name: Stage HiveOS artifact
        run: |
          mkdir -p hiveos-staging/vltrig
          cp build/vltrig hiveos-staging/vltrig/
          cp hiveos/h-manifest.conf hiveos-staging/vltrig/
          cp hiveos/h-config.sh hiveos-staging/vltrig/
          cp hiveos/h-run.sh hiveos-staging/vltrig/
          cp hiveos/h-stats.sh hiveos-staging/vltrig/
          chmod +x hiveos-staging/vltrig/vltrig hiveos-staging/vltrig/h-*.sh

      - name: Upload HiveOS artifact
        uses: actions/upload-artifact@v6
        with:
          name: vltrig-${{ env.VERSION }}-hiveos
          path: hiveos-staging/

  windows-gcc:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-libuv
            mingw-w64-ucrt-x86_64-openssl
            mingw-w64-ucrt-x86_64-nghttp2
            make git wget automake autoconf libtool

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build hwloc static
        run: |
          cd scripts
          sh build.hwloc.sh

      - name: Build
        run: |
          mkdir -p build && cd build
          cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release -DBUILD_STATIC=ON -DWITH_OPENCL=OFF -DWITH_CUDA=OFF -DXMRIG_DEPS=scripts/deps -DCMAKE_PREFIX_PATH="${MSYSTEM_PREFIX}"
          make -j$(nproc)
          strip vltrig.exe || true

      - name: Stage artifact
        run: |
          mkdir -p staging
          cp build/vltrig.exe scripts/vltrig/run.cmd src/config.json bin/WinRing0/WinRing0x64.sys staging/
          cd staging && sha256sum * > SHA256SUMS

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: vltrig-${{ env.VERSION }}-windows-gcc-x64
          path: staging/*

  macos-x64:
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install x86_64 Homebrew and dependencies
        run: |
          # Install x86_64 Homebrew under Rosetta
          arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          arch -x86_64 /usr/local/bin/brew install cmake libuv openssl hwloc nghttp2

      - name: Build
        run: |
          export PATH="/usr/local/bin:$PATH"
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_OSX_ARCHITECTURES=x86_64 \
                   -DCMAKE_EXE_LINKER_FLAGS="-lxml2 -liconv -lz -framework OpenCL" \
                   -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl \
                   -DUV_INCLUDE_DIR=/usr/local/opt/libuv/include \
                   -DUV_LIBRARY=/usr/local/opt/libuv/lib/libuv.a \
                   -DHWLOC_INCLUDE_DIR=/usr/local/opt/hwloc/include \
                   -DHWLOC_LIBRARY=/usr/local/opt/hwloc/lib/libhwloc.a
          make -j$(sysctl -n hw.ncpu)

      - name: Stage artifact
        run: |
          mkdir -p staging
          cp build/vltrig scripts/vltrig/run.sh src/config.json staging/
          cd staging && shasum -a 256 * > SHA256SUMS

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: vltrig-${{ env.VERSION }}-macos-x64
          path: staging/*

  macos-arm64:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          brew install cmake libuv openssl hwloc nghttp2

      - name: Build
        run: make release-ci

      - name: Stage artifact
        run: |
          mkdir -p staging
          cp build/vltrig scripts/vltrig/run.sh src/config.json staging/
          cd staging && shasum -a 256 * > SHA256SUMS

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: vltrig-${{ env.VERSION }}-macos-arm64
          path: staging/*

  release:
    needs: [linux, windows-gcc, macos-x64, macos-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Build .deb package
        run: |
          PKG_VERSION="${VERSION#v}"
          scripts/build-deb.sh \
            "artifacts/vltrig-${{ env.VERSION }}-linux-x64/vltrig" \
            "$PKG_VERSION" \
            "src/config.json" \
            "vltrig" \
            "dist/vltrig.service" \
            "vltrig miner - high performance RandomX CPU miner"
          mv vltrig_*.deb artifacts/
        env:
          VERSION: ${{ env.VERSION }}

      - name: Build .rpm package
        run: |
          sudo apt-get update && sudo apt-get install -y rpm
          PKG_VERSION="${VERSION#v}"
          scripts/build-rpm.sh \
            "artifacts/vltrig-${{ env.VERSION }}-linux-x64/vltrig" \
            "$PKG_VERSION" \
            "src/config.json" \
            "vltrig" \
            "dist/vltrig.service" \
            "vltrig miner - high performance RandomX CPU miner"
          mv vltrig-*.rpm artifacts/
        env:
          VERSION: ${{ env.VERSION }}

      - name: Package artifacts
        run: |
          cd artifacts

          tar -czvf vltrig-${{ env.VERSION }}-linux-x64.tar.gz -C vltrig-${{ env.VERSION }}-linux-x64 .
          tar -czvf vltrig-${{ env.VERSION }}-macos-x64.tar.gz -C vltrig-${{ env.VERSION }}-macos-x64 .
          tar -czvf vltrig-${{ env.VERSION }}-macos-arm64.tar.gz -C vltrig-${{ env.VERSION }}-macos-arm64 .
          cd vltrig-${{ env.VERSION }}-windows-gcc-x64 && zip ../vltrig-${{ env.VERSION }}-windows-gcc-x64.zip * && cd ..

          # HiveOS package: filename must parse as name=vltrig so custom-get finds vltrig/ directory
          tar -czvf vltrig-hiveos.tar.gz -C vltrig-${{ env.VERSION }}-hiveos .

          rm -rf vltrig-${{ env.VERSION }}-*/

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Sign checksums
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY not set, skipping signing"
            exit 0
          fi
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          cd artifacts
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback \
               --passphrase-fd 0 --armor --detach-sign SHA256SUMS

      - name: Sign .rpm package
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "allow-preset-passphrase" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent
          gpgconf --launch gpg-agent
          KEYGRIP=$(gpg --with-keygrip --list-secret-keys 2>/dev/null | grep -m1 Keygrip | awk '{print $3}')
          echo "$GPG_PASSPHRASE" | /usr/lib/gnupg/gpg-preset-passphrase --preset "$KEYGRIP"
          printf '%s\n' '%_gpg_name HashVault <root@hashvault.pro>' > ~/.rpmmacros
          rpmsign --addsign artifacts/vltrig-*.x86_64.rpm

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v6
        with:
          name: vltrig-deb
          path: artifacts/vltrig_*_amd64.deb

      - name: Upload .rpm artifact
        uses: actions/upload-artifact@v6
        with:
          name: vltrig-rpm
          path: artifacts/vltrig-*.x86_64.rpm

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: artifacts/*
          generate_release_notes: true
          tag_name: ${{ env.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-repos:
    needs: [release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y apt-utils createrepo-c rpm

      - name: Download .deb artifact
        uses: actions/download-artifact@v6
        with:
          name: vltrig-deb
          path: .

      - name: Download .rpm artifact
        uses: actions/download-artifact@v6
        with:
          name: vltrig-rpm
          path: .

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ]; then
            echo "GPG_PRIVATE_KEY not set, skipping repo update"
            exit 0
          fi
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Update APT repository
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          PAGES_DEPLOY_KEY: ${{ secrets.PAGES_DEPLOY_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: scripts/update-apt-repo.sh vltrig_*_amd64.deb

      - name: Update RPM repository
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          PAGES_DEPLOY_KEY: ${{ secrets.PAGES_DEPLOY_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: scripts/update-rpm-repo.sh vltrig-*.x86_64.rpm
